<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>購買清單（完整版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:#f4f6f8;margin:0}
    .container{max-width:760px;margin:32px auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);padding:20px}
    h1{text-align:center}
    h2{margin-top:24px;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
    input,select{padding:10px;border-radius:8px;border:1px solid #ccc}
    button{padding:10px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
    button.secondary{background:#6b7280}
    button.danger{background:#dc2626}
    ul{list-style:none;padding:0}
    li{border-bottom:1px solid #eee;padding:8px}
    .item-top{display:flex;justify-content:space-between;align-items:center}
    .item-left{display:flex;align-items:center;gap:8px}
    .completed{text-decoration:line-through;color:#9ca3af}
    .note{font-size:12px;color:#6b7280;margin-left:24px}
    .tag{font-size:12px;padding:2px 6px;border-radius:6px;color:#fff}
    .food{background:#16a34a}.daily{background:#2563eb}.drug{background:#9333ea}.other{background:#6b7280}
    .imgs{display:flex;gap:8px;flex-wrap:wrap;margin-left:24px;margin-top:6px}
    .imgs img{width:80px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:10}
    .modal img{max-width:90%;max-height:90%}
  </style>
</head>
<body>
<div class="container">
<h1>購買清單（完整功能）</h1>
<div class="row"><input id="item" placeholder="項目"><input id="qty" type="number" min="1" value="1"></div>
<div class="row"><select id="cat"><option>食物</option><option>生活用品</option><option>藥妝</option><option>其他</option></select><input id="price" type="number" placeholder="單價"></div>
<div class="row"><input id="note" placeholder="備註"><input type="file" id="imgs" accept="image/*" multiple></div>
<div class="row" id="drug" style="display:none"><input id="dosage" placeholder="用量"><select id="rx"><option>非處方</option><option>處方藥</option></select></div>
<button style="width:100%" onclick="add()">新增</button>
<div style="display:flex;gap:8px;margin-top:12px"><button class="secondary" onclick="exportZip()">匯出 Excel + 圖片 ZIP</button><button class="danger" onclick="clearDone()">清空已完成</button></div>
<div id="lists"></div>
<h2 id="total"></h2>
</div>
<div class="modal" id="modal" onclick="this.style.display='none'"><img></div>
<script>
let items=JSON.parse(localStorage.getItem('list'))||[];
cat.onchange=()=>drug.style.display=cat.value==='藥妝'?'grid':'none';
function save(){localStorage.setItem('list',JSON.stringify(items));}
function toBase64(f){return new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(f);});}
async function add(){if(!item.value.trim())return;const imgsArr=[];for(const f of imgs.files)imgsArr.push(await toBase64(f));items.push({item:item.value,qty:+qty.value,cat:cat.value,price:+price.value||0,note:note.value,dosage:dosage.value,rx:rx.value,imgs:imgsArr,done:false});item.value=note.value=dosage.value='';qty.value=1;price.value='';imgs.value='';save();render();}
function clearDone(){items=items.filter(i=>!i.done);save();render();}
function render(){lists.innerHTML='';let sum=0;['食物','生活用品','藥妝','其他'].forEach(c=>{const g=items.filter(i=>i.cat===c);if(!g.length)return;lists.innerHTML+=`<h2>${c}</h2>`;const ul=document.createElement('ul');g.forEach(i=>{sum+=i.price*i.qty;const li=document.createElement('li');li.innerHTML=`<div class='item-top'><div class='item-left'><input type='checkbox' ${i.done?'checked':''}><span class='${i.done?'completed':''}'>${i.item} × ${i.qty} ($${i.price})</span><span class='tag ${c==='食物'?'food':c==='生活用品'?'daily':c==='藥妝'?'drug':'other'}'>${c}</span></div></div>`;li.querySelector('input').onchange=e=>{i.done=e.target.checked;save();render();};if(i.note)li.innerHTML+=`<div class='note'>備註：${i.note}</div>`;if(i.cat==='藥妝')li.innerHTML+=`<div class='note'>用量：${i.dosage||'-'} / ${i.rx}</div>`;if(i.imgs.length){const d=document.createElement('div');d.className='imgs';i.imgs.forEach(src=>{const im=document.createElement('img');im.src=src;im.onclick=()=>{modal.style.display='flex';modal.querySelector('img').src=src};d.append(im)});li.append(d);}ul.append(li)});lists.append(ul)});total.textContent=`總金額：$${sum}`}
async function exportZip(){const zip=new JSZip();let csv='分類,品項,數量,單價,備註,用量,是否處方\n';items.forEach((i,idx)=>{csv+=`${i.cat},${i.item},${i.qty},${i.price},${i.note||''},${i.dosage||''},${i.rx||''}\n`;i.imgs.forEach((img,n)=>{zip.file(`images/${idx}_${n}.png`,img.split(',')[1],{base64:true});});});zip.file('list.csv',csv);const blob=await zip.generateAsync({type:'blob'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='shopping_list.zip';a.click();}
render();
</script>
</body>
</html>
